<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SIP</title>
    <script src="jssip.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 50px; }
        #log { white-space: pre-wrap; text-align: left; margin: 20px auto; width: 80%; max-width: 600px; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        button, select, input { padding: 10px; font-size: 16px; margin: 10px; display: block; width: 90%; max-width: 300px; margin: 10px auto; }
    </style>
</head>
<body>

    <h1>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ SIP</h1>
    <input type="text" id="wsServer" placeholder="WebSocket (WSS) —Å–µ—Ä–≤–µ—Ä" value="wss://147.45.157.8:8443">
    <input type="text" id="sipUri" placeholder="SIP URI (–Ω–∞–ø—Ä–∏–º–µ—Ä, sip:202@147.45.157.8)" value="sip:202@147.45.157.8">
    <input type="password" id="sipPassword" placeholder="–ü–∞—Ä–æ–ª—å SIP" value="202">
    <button onclick="connectSIP()">üîÑ –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>

    <h2>–í—ã–±–µ—Ä–∏—Ç–µ, –∫–æ–º—É –∑–≤–æ–Ω–∏—Ç—å:</h2>
    <select id="sipList" onchange="updateCustomInput()">
        <option value="sip:201@147.45.157.8">–û–ø–µ—Ä–∞—Ç–æ—Ä 201</option>
        <option value="sip:202@147.45.157.8">–û–ø–µ—Ä–∞—Ç–æ—Ä 202</option>
        <option value="custom">–î—Ä—É–≥–æ–π SIP-–∞–¥—Ä–µ—Å...</option>
    </select>
    <input type="text" id="customSip" placeholder="–í–≤–µ–¥–∏—Ç–µ SIP-–∞–¥—Ä–µ—Å" style="display:none;">
    
    <button onclick="makeCall()">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
    <button onclick="hangupCall()">üì¥ –ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>

    <div id="log"></div>

    <script>
        let ua, session;

        function logMessage(msg) {
            document.getElementById("log").innerText += msg + "\n";
        }

        function connectSIP() {
            const wsServer = document.getElementById("wsServer").value.trim();
            const sipUri = document.getElementById("sipUri").value.trim();
            const sipPassword = document.getElementById("sipPassword").value.trim();

            if (!wsServer || !sipUri || !sipPassword) {
                logMessage("‚ùå –£–∫–∞–∂–∏—Ç–µ –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏!");
                return;
            }

            logMessage(`üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ ${sipUri} —á–µ—Ä–µ–∑ ${wsServer}...`);

            try {
                const socket = new JsSIP.WebSocketInterface(wsServer);
                ua = new JsSIP.UA({
                    sockets: [socket],
                    uri: sipUri,
                    password: sipPassword,
                    registrar_server: sipUri.split("@")[1],
                    display_name: "SIP User",
                    session_timers: false
                });

                ua.on("registered", () => logMessage("‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ!"));
                ua.on("registrationFailed", (e) => logMessage(`‚ùå –û—à–∏–±–∫–∞: ${e.cause}`));
                ua.on("newRTCSession", (data) => handleIncomingCall(data.session));

                ua.start();
            } catch (error) {
                logMessage(`‚ùå –û—à–∏–±–∫–∞: ${error}`);
            }
        }

        function handleIncomingCall(call) {
            session = call;
            logMessage("üìû –í—Ö–æ–¥—è—â–∏–π –∑–≤–æ–Ω–æ–∫...");
            session.on("accepted", () => logMessage("‚úÖ –ó–≤–æ–Ω–æ–∫ –ø—Ä–∏–Ω—è—Ç"));
            session.on("ended", () => logMessage("‚ùå –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"));
            session.on("failed", (e) => logMessage(`‚ùå –û—à–∏–±–∫–∞: ${e.cause}`));
        }

        function updateCustomInput() {
            document.getElementById("customSip").style.display = (document.getElementById("sipList").value === "custom") ? "inline" : "none";
        }

        function makeCall() {
            if (!ua) return logMessage("‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!");

            let target = document.getElementById("sipList").value;
            if (target === "custom") {
                target = document.getElementById("customSip").value.trim();
                if (!target) return logMessage("‚ùå –í–≤–µ–¥–∏—Ç–µ SIP-–∞–¥—Ä–µ—Å!");
            }

            logMessage(`üìû –ó–≤–æ–Ω–∏–º –Ω–∞: ${target}`);
            session = ua.call(target, {
                mediaConstraints: { audio: true, video: false },
                pcConfig: { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] },
                eventHandlers: { sdp: modifySDP }
            });

            session.on("progress", () => logMessage("‚è≥ –ó–≤–æ–Ω–æ–∫ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ..."));
            session.on("confirmed", () => logMessage("‚úÖ –ó–≤–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"));
            session.on("ended", () => logMessage("‚ùå –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"));
            session.on("failed", (e) => logMessage(`‚ùå –û—à–∏–±–∫–∞: ${e.cause}`));
        }

        function modifySDP(e) {
            console.log("üîß –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π SDP:\n", e.sdp);

            // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–¥–µ–∫–∏ PCMU (0) –∏ PCMA (8)
            e.sdp = e.sdp.replace(/a=rtpmap:\d+ (?!PCMU|PCMA).*?\r\n/g, "");

            // –ú–µ–Ω—è–µ–º RTP-—Ñ–æ—Ä–º–∞—Ç –Ω–∞ RTP/AVP, –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è
            if (!e.sdp.includes("RTP/AVP")) {
                e.sdp = e.sdp.replace(/UDP\/TLS\/RTP\/SAVPF/g, "RTP/AVP");
            }

            console.log("üéõÔ∏è –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SDP:\n", e.sdp);
        }

        function hangupCall() {
            if (session) {
                session.terminate();
                logMessage("üì¥ –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω.");
            } else {
                logMessage("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞.");
            }
        }
    </script>

</body>
</html>
