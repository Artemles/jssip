<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SIP</title>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–π JsSIP -->
    <script src="jssip.min.js"></script>

    <style>
        body { font-family: Arial, sans-serif; text-align: center; margin: 50px; }
        #log { white-space: pre-wrap; text-align: left; margin: 20px auto; width: 80%; max-width: 600px; border: 1px solid #ccc; padding: 10px; background: #f9f9f9; }
        button { padding: 10px 20px; font-size: 16px; margin: 10px; }
    </style>
</head>
<body>

    <h1>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SIP</h1>
    <button onclick="connectSIP()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
    <button onclick="makeCall()">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</button>
    <button onclick="hangupCall()">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∑–≤–æ–Ω–æ–∫</button>
    <div id="log"></div>

    <script>
        let ua;  // –û–±—ä–µ–∫—Ç SIP User Agent
        let session;  // –ê–∫—Ç–∏–≤–Ω—ã–π SIP-–∑–≤–æ–Ω–æ–∫

        function logMessage(message) {
            document.getElementById("log").innerText += message + "\n";
        }

        function connectSIP() {
            logMessage("üîÑ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ SIP —á–µ—Ä–µ–∑ WebSocket...");

            try {
                const socket = new JsSIP.WebSocketInterface("wss://147.45.157.8:8443");
                const configuration = {
                    sockets: [socket],
                    uri: "sip:202@147.45.157.8",
                    password: "202",  // –ü–∞—Ä–æ–ª—å SIP-–∞–∫–∫–∞—É–Ω—Ç–∞
                    registrar_server: "sip:147.45.157.8",
                    display_name: "SIP User 202",
                    session_timers: false,
                };

                ua = new JsSIP.UA(configuration);

                ua.on("connected", () => logMessage("‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω"));
                ua.on("disconnected", () => logMessage("‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω"));
                ua.on("registered", () => logMessage("‚úÖ SIP –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω"));
                ua.on("registrationFailed", (event) => logMessage(`‚ùå –û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ${event.cause}`));

                ua.start();
            } catch (error) {
                logMessage(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error}`);
            }
        }

        function makeCall() {
            if (!ua) {
                logMessage("‚ùå SIP-–∫–ª–∏–µ–Ω—Ç –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω!");
                return;
            }

            const target = "sip:201@147.45.157.8"; // –ö–æ–º—É –∑–≤–æ–Ω–∏–º
            const options = {
                mediaConstraints: { audio: true, video: false },
                eventHandlers: {
                    sdp: function(e) {
                        console.log("üîß –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π SDP:\n" + e.sdp);

                        // üîπ 1. –£–±–∏—Ä–∞–µ–º Opus (111), –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç
                        e.sdp = e.sdp.replace(/a=rtpmap:111 .*\r\n/g, "");

                        // üîπ 2. –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —Å—Ç–∞–≤–∏–º ptime=20 (–ø—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–º–µ–Ω–æ–π)
                        if (e.sdp.includes("a=fmtp:111 minptime=10;useinbandfec=1")) {
                            e.sdp = e.sdp.replace(
                                /a=fmtp:111 minptime=10;useinbandfec=1/g,
                                "a=fmtp:111 minptime=20;useinbandfec=1"
                            );
                        }

                        // üîπ 3. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ª–∏ —Å–µ—Ä–≤–µ—Ä `UDP/TLS/RTP/SAVPF`, –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî –º–µ–Ω—è–µ–º –Ω–∞ `RTP/AVP`
                        if (!e.sdp.includes("RTP/AVP")) {
                            e.sdp = e.sdp.replace(/UDP\/TLS\/RTP\/SAVPF/g, "RTP/AVP");
                        }

                        console.log("üéõÔ∏è –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π SDP:\n" + e.sdp);
                    },

                    icecandidate: function(event) {
                        if (!event.candidate) {
                            console.log("üöÄ ICE –∫–∞–Ω–¥–∏–¥–∞—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã");
                        }
                    }
                }
            };

            session = ua.call(target, options);
            session.on("progress", () => logMessage("‚è≥ –ó–≤–æ–Ω–æ–∫ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ..."));
            session.on("confirmed", () => logMessage("‚úÖ –ó–≤–æ–Ω–æ–∫ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"));
            session.on("ended", () => logMessage("‚ùå –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω"));
            session.on("failed", (e) => logMessage(`‚ùå –û—à–∏–±–∫–∞ –∑–≤–æ–Ω–∫–∞: ${e.cause}`));
        }

        function hangupCall() {
            if (session) {
                session.terminate();
                logMessage("üì¥ –ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω –≤—Ä—É—á–Ω—É—é.");
            } else {
                logMessage("‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–≤–æ–Ω–∫–∞.");
            }
        }

        // –í–∫–ª—é—á–∞–µ–º –æ—Ç–ª–∞–¥–∫—É JsSIP
        JsSIP.debug.enable("JsSIP:*");

    </script>

</body>
</html>
